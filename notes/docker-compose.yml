services:
  obsidian:
    image: lscr.io/linuxserver/obsidian:latest
    container_name: obsidian
    restart: unless-stopped
    shm_size: "1gb"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TIMEZONE}
    volumes:
      - obsidian_config:/config
    networks:
      - proxy_net
    labels:
      - docker-volume-backup.stop-during-backup=obsidian

  couchdb:
    image: ghcr.io/vrtmrz/couchdb:latest
    container_name: couchdb
    restart: unless-stopped
    environment:
      - COUCHDB_USER=${COUCHDB_USER}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - couchdb_data:/opt/couchdb/data
    networks:
      - proxy_net

  backup:
    image: offen/docker-volume-backup:latest@sha256:26df48fdb7bd32f114fc7420beae3960055ae1f40ba5ff3bfd787cb5f15fefa5
    container_name: obsidian-backup
    restart: unless-stopped
    environment:
      - BACKUP_CRON_EXPRESSION=0 3 * * *
      - BACKUP_RETENTION_DAYS=30
      - BACKUP_FILENAME=obsidian-%Y-%m-%dT%H-%M-%S.tar.gz
      - BACKUP_ARCHIVE=/archive/documents/notes
      - TZ=${TIMEZONE}
    volumes:
      - obsidian_config:/backup/obsidian_config:ro
      - nas_backup:/archive
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /usr/share/zoneinfo:/usr/share/zoneinfo:ro
    networks:
      - proxy_net

volumes:
  obsidian_config:
    driver: local
    driver_opts:
      type: cifs
      device: //${NAS_IP}/${NAS_NOTES_SHARE}
      o: addr=${NAS_IP},username=${NAS_NOTES_USER},password=${NAS_NOTES_PASSWORD},file_mode=0700,dir_mode=0700,uid=${PUID},gid=${PGID}
  couchdb_data:
    driver: local
    driver_opts:
      type: cifs
      device: //${NAS_IP}/${NAS_NOTES_SHARE}/couchdb
      o: addr=${NAS_IP},username=${NAS_NOTES_USER},password=${NAS_NOTES_PASSWORD},file_mode=0700,dir_mode=0700,uid=5984,gid=5984
  nas_backup:
    driver: local
    driver_opts:
      type: cifs
      device: //${NAS_IP}/${NAS_BACKUP_SHARE}
      o: addr=${NAS_IP},username=${NAS_BACKUP_USER},password=${NAS_BACKUP_PASSWORD},file_mode=0700,dir_mode=0700

networks:
  proxy_net:
    external: true
